# 生成二维码&微信支付&支付日志

## 03_二维码生成QRious插件

#### 目标

> 完成Qrious插件生成二维码

#### 实现步骤

+ 引用qrious.min.js文件

+ 定义二维码生成容器<img/>标签

+ 调用QRious({})函数生成二维码

  ![1563843294618](assets/1563843294618.png)

#### 小结

> 核心函数：new QRious({})

## 04_二维码生成zxing框架

#### 目标

> 完成zxing框架生成二维码

#### 实现步骤

+ 配置依赖jar包
+ 定义控制器类
+ 使用zxing核心api生成二维码

#### 小结

```xml
<!-- 配置二维码生成的框架 -->
<dependency>
    <groupId>com.google.zxing</groupId>
    <artifactId>javase</artifactId>
    <version>3.1.0</version>
</dependency>
```

BarCodeController.java

## 05_微信扫码支付简介

#### 目标

> 了解微信扫码支付

#### 小结

![1563845959553](assets/1563845959553.png)

## 06_搭建支付服务工程

#### 目标

> 完成支付服务工程搭建

#### 小结

> pinyougou-pay-service工程(服务提供者)

## 07_支付二维码生成(需求分析)

#### 目标

> 了解支付二维码生成需求
>
> 在支付页面生成支付二维码

生成二维码：QRious插件

调用微信支付系统的“统一下单接口” code_url

#### 小结

> + 利用QRious生成二维码。
> + 调用微信支付系统,统一下单接口,得到code_url。

## 08_支付二维码生成(前端代码)

#### 目标

> 完成支付二维码生成前端代码

![1563847509282](assets/1563847509282.png)

#### 实现步骤

+ 引用js (qrious.min.js)

+ 定义生成二维码方法(发送异步请求)

  ![1563848189899](assets/1563848189899.png)

#### 小结

> Qrious插件使用

## 09_支付二维码生成(后端代码)

#### 目标

> 完成支付二维码生成后端代码
>
> 微信支付在线api文档: <https://pay.weixin.qq.com/wiki/doc/api/index.html>

#### 实现步骤

+ 在控制器中,定义生成二维码的http请求方法

+ 调用微信支付服务接口

+ 在微信支付服务接口实现类中实现统一下单接口的调用

  ![1563849742452](assets/1563849742452.png)

#### 小结

> 统一下单接口调用:
>
> 1. 请求URL
> 2. 请求参数(xml格式、加签名)
> 3. 发送请求https请求
> 4. 响应数据(xml)
> 5. 获取code_url

## 10_支付二维码生成(zxing框架)

#### 目标

> 完成zxing框架生成支付二维码

#### 实现步骤

+ 配置zxing依赖jar包
+ 开发控制器类利用zxing核心api生成登录二维码
+ 提供html页面，用<img/>标签的src属性请求控制器显示登录二维码

#### 小结

> zxing框架核心api:
>
> 1. BitMatrix 二维码字节转换，包含二维码图片中的内容、二维码格式器、二维码宽度、二维码高度、二维码配置信息。
>    BitMatrix matrix = new MultiFormatWriter().encode(url, 
>    			BarcodeFormat.QR_CODE, WIDTH, HEIGHT, hints);
> 2. MatrixToImageWriter 输出二维码
>    MatrixToImageWriter.writeToStream(matrix, "png", 
>                 response.getOutputStream());

## 11_检测支付状态(需求分析)

#### 目标

> 了解检测支付状态需求

#### 需求分析

+ 当用户支付成功，需要跳转到支付成功页面
+ 当用户支付失败，需要跳转到支付失败页面
+ 当用户未支付，停留当前页面

#### 实现分析

+ 前端需要定时发送异步请求
+ 调用微信支付系统的“查询订单”接口，获取支付状态

## 12_检测支付状态(前端代码)

#### 目标

> 实现检测支付状态前端代码

#### 实现步骤

+ 定时发送异步请求(定时器)

#### 小结

> setInterval("回调函数","毫秒数")
>
> setTimeout()

## 13_检测支付状态(后端代码)

#### 目标

> 实现检测支付状态后端代码
>
> 微信支付在线api文档: <https://pay.weixin.qq.com/wiki/doc/api/index.html>

#### 实现步骤

+ 调用微信支付系统的"查询订单"接口

![1563851845792](assets/1563851845792.png)

![1563852351465](assets/1563852351465.png)

#### 小结

> 参考：微信支付在线api文档

## 14_支付成功页面(显示金额)

#### 目标

> 完成支付成功页面显示支付金额

#### 实现步骤

+ 在支付页面带请求参数到支付成功页面
+ 在支付成功页面获取参数，再显示

## 15_插入支付日志

#### 目标

> 实现支付日志保存到支付日志表: tb_pay_log

#### 实现步骤

+ 修改保存订单的方法

## 16_完善支付二维码生成

#### 目标

> 实现支付二维码的支付金额来自我们的订单金额

#### 实现步骤

+ 查询支付日志表中的记录，生成支付二维码

#### 小结

> 从Redis中获取用户最新需要支付的订单

## 17_修改支付状态&订单状态

#### 目标

> 当支付成功,修改支付状态与订单状态

#### 实现步骤

+ 修改查询支付状态的控制器
+ 调用服务接口修改支付状态与订单状态
+ 从Redis数据库中删除支付日志

## 18_显示登录用户名

#### 目标

> 实现登录用户名显示

#### 实现步骤

+ 支付失败页面显示登录用户名
